#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

mktmpdir() {
  dir=$(mktemp -t node-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}
function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}


#S3_BUCKET="cl-heroku"
#CCL_PACKAGE="http://${S3_BUCKET}.s3.amazonaws.com/ccl-1.7.tgz"
CL_PACKAGE="http://dl.dropbox.com/u/28383763/sbcl-1.0.55-x86-darwin-binary.tar.bz2"


# parse and derive params
BUILDPACK_DIR=$(cd $(dirname $0); cd ..; pwd) # absolute path of buildpack
BUILD_DIR=$1
CACHE_DIR=$2

CL_DIR="$CACHE_DIR/sbcl"

echo "-----> compile params: $BUILD_DIR $CACHE_DIR"

echo "-----> Installing sbcl"
if [ ! -d $CL_DIR ]; then
    echo "-----> Fetching sbcl"
    mkdir -p $CL_DIR  && curl $CL_PACKAGE -v -s -o -  | tar xzfv - -C $CL_DIR
fi

# add to slug 
cp -r $CL_DIR $BUILD_DIR

echo "sbcl installed" | indent

# setting up paths for building

#echo "-----> Getting patched versions of libraries"
## get patched aserve
#if [ -d $CACHE_DIR/repos/portableaserve ]; then
#     echo 'aserve already present'
## this was having difficulties, so let's not bother updating
##    pushd $CACHE_DIR/repos/portableaserve
##    git pull origin master
##    popd
#else 
#    mkdir $CACHE_DIR/repos
#    pushd $CACHE_DIR/repos
#    git clone git://github.com/mtravers/portableaserve.git
#    popd
#fi

export BUILDPACK_DIR
export CACHE_DIR
export BUILD_DIR
export CL_DEFAULT_DIRECTORY=$CL_DIR

echo "-----> Starting build"
sh $CL_DEFAULT_DIRECTORY/sbcl-1.0.55-x86-darwin/run-sbcl.sh --load "$BUILDPACK_DIR/setup/compile.lisp"
echo "-----> Build finished"

chmod a+x $BUILD_DIR/lispapp

